<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dragon Glory</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://universal-client.101xp.com/xp_guid.js"></script>
    <script type="text/javascript" src='//www.googleadservices.com/pagead/conversion_async.js'></script>
    <script type="text/javascript" src="/_libs/js/app1635341907499.min.js"></script>
    <script type="text/javascript">
        var ip = '127.0.0.1', paramsAd = '{}', platformguid = '00000000', STimeFormatted = '<?php echo $serverTimeFormat; ?>';
    </script>
    <!--endinjectdote-->
    <link href="https://fonts.googleapis.com/css?family=PT+Sans:400,700" rel="stylesheet">
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            'gtm.start':
                new Date().getTime(), event: 'gtm.js'
        });
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src =
            'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-MWGBWTB');</script>
    <!-- End Google Tag Manager -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript" src="https://portal-id-en.101xp.com/xp-widget-listener.js"></script>
    <script type="text/javascript" src="/_libs/js/fancybox/jquery.fancybox.pack.js"></script>
    <link rel="stylesheet" type="text/css" href="/_libs/js/fancybox/jquery.fancybox.css">
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MWGBWTB"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="xpAuthWidget"
     style="margin: 0 auto; padding: 0; width: 100%; min-width: 799px; max-width: 2560px; height: 40px; background: #183b41; position: relative; z-index: 9999; display: none;">
    <iframe id="auth" name="header"
            style="z-index: 1; position:fixed; margin: 0; padding: 0; width: 100%; height:40px; border: none"
            src="https://portal-id-en.101xp.com/header"></iframe>
</div>
<div class="main">
    <form id="profileForm" class="form_main" action="//101xp.com/" method="get">
        <img class="dragonglory_logo" src="images/logo_dragonglory3.png" alt="">
        <input name="username" maxlength="100" type="hidden" value=""/>
        <input name="generate" maxlength="100" type="hidden" value="yes"/>

        <!--        <div class="social_block">-->
        <!--            <a class="social_login fb" data-provider="facebook"> </a>-->
        <!--        </div>-->
        <div class="wrap-btn wrap-btn-status_part">
            <div class="play_btn btn action__btn btn_part"></div>
            <div class="play_btn btn action__btn btn_down"></div>
        </div>
        <p class="info_links">
            By Clicking "Play Now", you confirm that you have read and<br>agreed to our <a target="_blank"
                                                                                           href="http://en.101xp.com/pages/eula"
                                                                                           id="eula">Terms of
            Service</a> and <a target="_blank" href="http://en.101xp.com/pages/policy" id="policy">Privacy Policy</a>.
        </p>
        <a class="logo_101xp" href="https://101xp.com"><img src="images/101xp_logo.png" alt="101XP.com"></a>
    </form>
</div>
<!-- popup -->
<div class="popup-common">
    <div class="popup-common__close js--cbt-close">✖</div>
    <div class="popup-common__wrap cbt-success">
        <div class="cbt-success__heading"><h4>Successful registration</h4></div>
        <div class="cbt-success__content"><p class="popup-common__text">You have successfully registration. Now you can
            download the game!</p>
            <button class="btn btn--main btn--green js--cbt-success-button">
                <span>Game download</span></button>
        </div>
    </div>
</div>

<script type="text/javascript">
    var options = {
        widgetHost: 'https://portal-id-en.101xp.com',
        onePageApp: true,
        hideNicknameSingUp: true,
    };

    new LandingsCore({
            game_url: '//en.101xp.com/games/dragonglory/play',
            game_id: '376D6712888B2',
            redirect_to_game: false,
            page_id: 1629,
            project_id: 271,
            send_params: true,
            type_form: 'mail',
            locale: 'en',
            stat: {
                metriks: { // данные и номера счетчиков
                    yandex: {
                        id: 25528898,
                        reg_targets: {
                            social: 'SOCIALBTN',
                            play_btn: 'LOGINBTN',
                            success_reg: 'SIGNUP'
                        }
                    },
                    google: {
                        id: 'UA-69106995-4',
                        reg_targets: {
                            category: 'regDK2EN',
                            social: 'SOCIALBTN',
                            play_btn: 'LOGINBTN',
                            success_reg: 'activregDK2EN'
                        }
                    },
                    facebook: {
                        id: '1236628936456411'
                    },
                    vk_rtg: function () {
                        (window.Image ? (new Image()) : document.createElement('img')).src = location.protocol + '//vk.com/rtrg?r=NWGe8NgYxcYkbqNr6GHxUEGtZHEINCUFXZe20C3f0EhAJE6Wu4KHLsFgwtC3yRNsAoef63miuQBbh4Pv9EiwKgp71/MBx4SZwoj1u/9FDmPxnO9uz8DaSJ*c/R2SeeKoWM9HJxQj73WRus6ROZS6HvAyin5VmBQ7SonHUmt0h*E-&pixel_id=1000007809'
                    }
                },
                partners: {
                    adwords: {
                        id: 851275090,
                        label: "dH02CL7g03EQ0tr1lQM"
                    },
                    facebook: {
                        id: '1236628936456411',
                        track_all: true
                    }
                }
            },
            help_forms: false,
            ip: ip,
            paramsAd: paramsAd,
            platformguid: platformguid
        }
    );

    function getUID(dataUID) {
        console.log(Cookies.get('auth_token'));
        if(Cookies.get('auth_token')){
            var requestOptions = {
                headers: {
                    Authorization: 'Bearer ' + Cookies.get('auth_token'),
                    Accept: 'application/json'
                },
                type: 'GET',
                url: APIUrl + 'account',
                dataType: 'json',
                success: function (response) {
                    if ((response.responseText && response.responseText != '') || typeof response != 'object') {

                        if (response.responseText != '') {
                            done(JSON.parse(response.responseText));
                        } else {
                            done(JSON.parse(response));
                        }
                    } else {
                        done(response);
                    }
                },
                error: function (error) {
                }
            };

            $.ajax(requestOptions);

            function done(res) {
                //console.table(res);
                if (res.status === 'success') {
                    window['uid_data'] = res.account.id;
                    console.log(res.account.id);
                    new SendAds({uid: res.account.id});
                }
            }
        }
    }


    $(document).ready(function () {

        if (window.addEventListener) {
            window.addEventListener("message", listener);
        } else {
            // IE8
            window.attachEvent("onmessage", listener);
        }

        XPWidget.init(options);
        XPWidget.callEvent("getAuthTokens");

        XPWidget.addEvent('login-success', function () {
            // window.location.reload();
        });

        XPWidget.addEvent('register-success', function () {
            // window.location.reload();
        });

        // var api_url = 'https://api.101xp.com/';

        // инициализация портальной панели
        var cookieAuth = Cookies.get("auth_token");
        console.log(cookieAuth);

        function modalOpen() {
            $(".popup-common").css({display: 'flex'});
        }

        function modalClose() {
            $(".popup-common").css({display: 'none'});
        }

        $('.js--cbt-close').click(function () {
            modalClose();
        })

        function btnDown() {
            // $(".wrap-btn").removeClass("wrap-btn-status_part").addClass("wrap-btn-status_down");
            $(".btn_part").css({display: 'none'});
            $(".btn_down").css({display: 'inline-block'});
        }

        function partOn() {
            // $(".wrap-btn").removeClass("wrap-btn-status_part").addClass("wrap-btn-status_down");
            $(".btn_down").css({display: 'none'});
            $(".btn_part").css({display: 'inline-block'});
        }

        var refresh_token = Cookies.get("refresh_token"),
            auth_token = Cookies.get("auth_token");

        if (refresh_token && auth_token) {
            btnDown();
            $('.btn_down').click(function () {
                modalOpen();
            })
            new SendEvent({type: 'click', element: 'Download'});

        } else {
            partOn();
        }

        $('.btn_down').click(function () {
            modalOpen();
        })

        $('.btn_part').click(function () {
            XPWidget.callEvent('signup');
        });

        $('.js--cbt-success-button').click(function () {
            Cookies.remove('launcher_loaded', CookiesParams.week);
            new Launcher({status: true});
            trackDownloadEvent();
            getUID();
            //  стата - скачивание
            dataLayer.push({
                event: 'download_gc',
                eventCategory: game_id,
                eventAction: 'download',
                page_id: page_id
            });
            modalClose();
        });


        function listener(event, d) {
            try {
                var data = JSON.parse(event.data);

                if (data.event === "setAuthTokens") {

                    if (window.location.href.indexOf('localhost')) {
                        console.log(data);
                        Cookies.set("auth_token", data.data.access_token);
                        Cookies.set("refresh_token", data.data.refresh_token);
                    }
                    if (!Cookies.get("auth_token") || !Cookies.get("refresh_token")) {
                        console.log('noo');
                    }

                    cookieAuth = data.data.access_token;
                }

                if (data.event === 'showAccountData') {
                    // new SendAds({uid: data.data.userData.id });
                }

                if (data.event === "login-success") {
                    // XPWidget.callEvent('getAccountData');
                    getUID();
                    trackLoginEvent()
                    //  стата - авторизация
                    dataLayer.push({
                        event: 'authorization',
                        eventCategory: game_id,
                        eventAction: 'signin',
                        page_id: page_id
                    });
                    btnDown();
                    modalOpen();
                }

                if (data.event === "logout-success") {
                    window.location.reload();
                }

                if (data.event === "register-success") {
                    getUID();
                    trackRegEvent()
                    //  стата - регистрация
                    dataLayer.push({
                        event: 'registration',
                        eventCategory: game_id,
                        eventAction: 'signup',
                        page_id: page_id
                    });
                    btnDown();
                    modalOpen();
                }

            } catch (e) {
            }
        }

        function trackLoginEvent() {
            new SendEvent({type: 'click', element: 'Login'});
        }

        function trackRegEvent() {
            new SendEvent({type: 'click', element: 'Register'});
        }

        function trackDownloadEvent() {
            new SendEvent({type: 'click', element: 'Download'});
        }

    });

</script>
<script type="text/javascript" src="lib/form.js?v=1"></script>
<?php require_once './../../../german_footer_text.php'; ?>
</body>
</html>
